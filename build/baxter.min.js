(function(e,t){"use strict";function r(e,t){return Array.prototype.slice.call(e,t||0)}function i(e){var t=r(arguments,1);for(var n=0,i=t.length;n<i;n++){var s=t[n];for(var o in s)e[o]=s[o]}return e}function s(e,t){return function(){return t.apply(e,arguments)}}function o(e){return e.replace(/^\s+|\s+$/g,"")}function u(e){var t=r(arguments,1),n=["[",e.constructor.className],i=[],s,o;if(t.length>0){for(var u=0;u<t.length;u++)s=t[u],s instanceof Array?(o=s[1](e),s=s[0]):typeof e[s]=="string"?o="'"+e[s].replace(/'/g,"\\'")+"'":o=e[s],typeof o=="function"&&(o=o.apply(e)),i.push(s+": "+o);n.push(" "),n.push(i.join(", "))}return n.push("]"),n.join("")}function a(e){this.message=e,this.name="EOFError"}function f(e){this.message=e,this.name="ParseError"}function l(e){this.context=e}function c(e){if(typeof e!="string")throw new TypeError("Buffer expects a string");this.string=e,this.position=-1,this.line=0,this.column=0}function h(){this.tree=[]}function p(){}function d(e,t){this.id=e,this.content=t,this.ast=p.parse(t)}function v(){this.cache={}}var n;i(a,{className:"EOFError"}),a.prototype=i(new Error,{constructor:a,toString:function(){return u(this,"message")}}),i(f,{className:"ParseError"}),f.prototype=i(new Error,{constructor:f,toString:function(){return u(this,"message")}}),i(l,{className:"Environment"}),i(l.prototype,{constructor:l,toString:function(){return u(this)},resolve:function(t){var n=t.split("."),r=this.context;try{for(var i=0;i<n.length;i++)r=r[n[i]]}catch(s){if(e.baxter.debug)throw s}return r}}),i(c,{className:"Buffer"}),i(c.prototype,{constructor:c,toString:function(){return u(this,"position","line","column")},eof:function(){return this.position>=this.string.length-1},peek:function(e){if(this.eof())throw new a;return this.string[this.position+(e||1)]},next:function(e){var t,n;e=e||1,t=[];while(e>0){if(this.eof())throw new a;this.position++,n=this.string[this.position],t.push(n),e--,n=="\n"||n=="\r"?(this.line++,this.column=0):this.column++}return t.join("")}}),i(h,{className:"AST"}),i(h.prototype,{constructor:h,toString:function(){return u(this,"length")},evaluate:function(e){return this.tree.map(function(t){return t.evaluate(e)}).join("")},length:function(){return this.tree.length},add:function(e){this.tree.push(e)},get:function(e){return this.tree[e]}}),h.Node=function(){},i(h.Node,{className:"AST.Node"}),i(h.Node.prototype,{constructor:h.Node,toString:function(){return u(this)},evaluate:function(e){return t}}),h.String=function(e,t,n){this.value=e,this.line=t,this.column=n},i(h.String,{className:"AST.String"}),h.String.prototype=i(new h.Node,{constructor:h.String,toString:function(){return u(this,"value","line","column")},evaluate:function(e){return this.value}}),h.Variable=function(e,t,n){this.name=e,this.line=t,this.column=n},i(h.Variable,{className:"AST.Variable"}),h.Variable.prototype=i(new h.Node,{constructor:h.Variable,toString:function(){return u(this,"name","line","column")},evaluate:function(e){return e.resolve(this.name)}}),i(p,{className:"Parser",instance:new p,parse:function(e){return this.instance.parse(e)}}),i(p.prototype,{constructor:p,toString:function(){return u(this)},parse:function(e){var t=new c(e),n=new h;while(!t.eof())this.parseNext(t,n);return n},parseNext:function(e,t){var n=e.peek();if(n=="{"){var r=e.peek(2);if(r=="{")this.parseVariable(e,t);else{if(r!="%")throw new f("Unknown statement syntax: '"+(n+r)+"' (line "+e.line+", column "+e.column);this.parseStatement(e,t)}}else this.parseString(e,t)},parseString:function(e,t){var n=e.line,r=e.column,i=[],s;try{while(e.peek()!="{")s=e.next(),s=="\\"?i.push(e.next()):i.push(s)}catch(o){if(!(o instanceof a))throw o}t.add(new h.String(i.join(""),n,r))},parseStatement:function(e,t){var n;e.next(2);while(e.peek()!="%")n=e.next();e.next(2)},parseVariable:function(e,t){var n=e.line,r=e.column,i,s=[];e.next(2);while(e.peek()!="}")i=e.next(),s.push(i);e.next(2),t.add(new h.Variable(o(s.join("")),n,r))}}),i(d,{className:"Template"}),i(d.prototype,{constructor:d,toString:function(){return u(this,"id","ast")},evaluate:function(e){return this.ast.evaluate(e)}}),i(v,{className:"Baxter"}),i(v.prototype,{constructor:v,toString:function(){return u(this)},clear:function(){this.cache={}},template:function(e,t){var n,r,i,s;if(typeof e!="string")throw new TypeError("Unknown template or template id: "+e);s=typeof t;if(s==="string")return this.register(e,t);if(s==="object"||s==="undefined")return this.evaluate(e,t||{});throw new TypeError("Unknown template or context: "+t)},register:function(e,t){this.cache[e]=new d(e,t)},evaluate:function(e,t){var n=this.get(e);return t instanceof Array?t.map(function(e){return n.evaluate(new l(e))}).join("\n"):n.evaluate(new l(t))},get:function(e){return e in this.cache||this.register(e,e),this.cache[e]}}),n=new v,n.template=s(n,n.template),n.template.debug=!1,e.baxter=n.template})(this);